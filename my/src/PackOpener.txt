// src/features/pack-opening/PackOpener.tsx (ä¿®æ­£å¾Œå…¨æ–‡)

import React from 'react';

import { usePackOpenerData } from './hooks/usePackOpenerData'; // [8]

import {
    Box, Typography, Select, MenuItem, FormControl, InputLabel,
    Button, Alert, Paper, Grid, Divider
} from '@mui/material'; // [8]

import type { SelectChangeEvent } from '@mui/material'; // SelectChangeEventã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ [8]

import { useCardData } from '../../hooks/useCardData'; // ğŸ’¡ è¿½è¨˜: useCardDataã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ [8]

interface PackOpenerProps {
    preselectedPackId?: string;
}

const PackOpener: React.FC<PackOpenerProps> = ({ preselectedPackId }) => { // [9]

    // Hookã‹ã‚‰çŠ¶æ…‹ã€ãƒ­ã‚¸ãƒƒã‚¯ã€é€šè²¨æƒ…å ±ã‚’å–å¾—
    const { // [9]
        packs,
        selectedPack,
        setSelectedPack,
        isLoading,
        handleOpenPack,
        lastOpenedResults,
        coins,
        purchaseError,
        simulationWarning, // ğŸ’¡ è¿½è¨˜: è­¦å‘ŠçŠ¶æ…‹ã‚’å–å¾—
    } = usePackOpenerData(preselectedPackId);

    // ğŸ’¡ è¿½è¨˜: useCardDataã‹ã‚‰ã‚«ãƒ¼ãƒ‰åå–å¾—é–¢æ•°ã‚’å–å¾—
    const { getCardName } = useCardData(); // [9] [10]

    if (isLoading) {
        return (
            <Typography>ãƒ‘ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</Typography>
        );
    }

    // ğŸ’¡ ä¿®æ­£: SelectChangeEventã‹ã‚‰ packId (string) ã‚’å–ã‚Šå‡ºã—ã€setSelectedPackã«æ¸¡ã™
    const handlePackSelect = (event: SelectChangeEvent) => { // [11]
        // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰é¸æŠã•ã‚ŒãŸå€¤ï¼ˆpackIdï¼‰ã‚’å–å¾—
        const packId = event.target.value; // [11]
        // Hookã‹ã‚‰å—ã‘å–ã£ãŸsetSelectedPackã« packId (string) ã‚’æ¸¡ã™
        setSelectedPack(packId); // [11]
    };

    // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    return (
        <Box sx={{ p: 2 }}>
            <Typography variant="h6" gutterBottom>
                ğŸ’° **æ‰€æŒã‚³ã‚¤ãƒ³:** {coins.toLocaleString()} G
            </Typography>

            {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            {purchaseError && ( // [11]
                <Alert severity="error" sx={{ mt: 2 }}>
                    {purchaseError}
                </Alert>
            )}
            
            {/* ğŸ’¡ æ–°è¦è¿½åŠ : ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            {simulationWarning && (
                <Alert severity="warning" sx={{ mt: 2 }}>
                    {simulationWarning}
                </Alert>
            )}

            <Grid container spacing={3} alignItems="flex-end" sx={{ mt: 1, mb: 3 }}>
                {/* 1. ãƒ‘ãƒƒã‚¯é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */}
                <Grid size={{xs:12, sm:6, md:4}}>
                    <FormControl fullWidth>
                        <InputLabel id="pack-select-label">é¸æŠãƒ‘ãƒƒã‚¯</InputLabel>
                        <Select
                            labelId="pack-select-label"
                            // selectedPackãŒnullã®å ´åˆã€MUI Selectã¯åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç©ºæ–‡å­—åˆ—ã‚’æ¸¡ã™
                            value={selectedPack?.packId || ''}
                            onChange={handlePackSelect}
                            label="é¸æŠãƒ‘ãƒƒã‚¯"
                        >
                            {packs.map(pack => ( // [12]
                                <MenuItem key={pack.packId} value={pack.packId}>
                                    {pack.name} ({pack.cardsPerPack}æš, {pack.price}G)
                                </MenuItem>
                            ))}
                        </Select>
                    </FormControl>
                </Grid>

                {/* 2. é–‹å°ãƒœã‚¿ãƒ³ */}
                <Grid size={{xs:12, sm:6, md:8}}>
                    <Button
                        variant="contained"
                        color="primary"
                        size="large"
                        onClick={handleOpenPack}
                        // ãƒ‘ãƒƒã‚¯æœªé¸æŠ or ã‚³ã‚¤ãƒ³ä¸è¶³ã§ç„¡åŠ¹åŒ–
                        disabled={!selectedPack || coins < (selectedPack?.price || 0)}
                        sx={{ minWidth: 200 }}
                    >
                        {selectedPack ? `${selectedPack.price} G ã§ ${selectedPack.name} ã‚’é–‹å°` : 'ãƒ‘ãƒƒã‚¯ã‚’é¸æŠ'}
                    </Button>
                </Grid>
            </Grid>
            
            <Divider sx={{ mb: 3 }} />

            {/* 3. é–‹å°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */}
            {lastOpenedResults && lastOpenedResults.length > 0 && ( // [13]
                <Paper elevation={3} sx={{ p: 3, mt: 3 }}>
                    <Typography variant="h5" gutterBottom>é–‹å°çµæœ</Typography>
                    <Typography variant="body2" color="success.main" sx={{ mb: 2 }}>
                        ğŸ‰ ãƒ‘ãƒƒã‚¯ã‚’é–‹å°ã—ã¾ã—ãŸï¼ä»¥ä¸‹ã®ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚
                    </Typography>
                    {/* ã‚«ãƒ¼ãƒ‰çµæœã®ãƒªã‚¹ãƒˆ */}
                    {lastOpenedResults.map((result, index) => ( // [13]
                        <Typography key={index} variant="body1">
                            *{getCardName(result.cardId)}* x {result.count}æš ({result.cardId})
                        </Typography>
                    ))}
                </Paper>
            )}
        </Box>
    );
};

export default PackOpener;