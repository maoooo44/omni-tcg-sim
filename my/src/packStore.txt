// src/stores/packStore.ts
import { create } from 'zustand';
import type { Pack, RarityConfig, } from '../models/pack'; //PackTypeã‚’å‰Šé™¤
import { v4 as uuidv4 } from 'uuid'; 
import { packService } from '../services/pack-logic/packService'; // ğŸ’¡ packServiceã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

const generatePackId = () => uuidv4();

// ğŸ’¡ æœ€å°é™ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
const DEFAULT_RARITY_CONFIG: RarityConfig[] = [{
    rarityName: 'Common',
    probability: 1.0, // 100%
}];

// Pack ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã†ã¡ã€è‡ªå‹•ã§ç”Ÿæˆ/è¨­å®šã•ã‚Œã‚‹ã‚‚ã®ã‚’é™¤å¤–ã—ãŸå‹
type NewPackData = Omit<Pack, 'packId' | 'totalCards' | 'isOpened'>;

export interface PackState {
    packs: Pack[];

    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    loadPacks: () => Promise<void>; 
    /** æ–°ã—ã„ãƒ‘ãƒƒã‚¯ã‚’ä½œæˆ (packId, totalCards, isOpened ã¯è‡ªå‹•è¨­å®š) */
    createPack: (newPackData: NewPackData) => Promise<void>; // ğŸ’¡ Promise<void>ã«å¤‰æ›´
    updatePack: (updatedPack: Pack) => Promise<void>; // ğŸ’¡ Promise<void>ã«å¤‰æ›´
    deletePack: (packId: string) => Promise<void>; // ğŸ’¡ Promise<void>ã«å¤‰æ›´
}

const initialState = {
    packs: [],
};

export const usePackStore = create<PackState>((set, _get) => ({
    ...initialState,
    
    // ğŸ’¡ å®Ÿè£…: DBã‹ã‚‰ãƒ‘ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¹ãƒˆã‚¢ã«ã‚»ãƒƒãƒˆã™ã‚‹
    loadPacks: async () => {
        try {
            // DBã‹ã‚‰å…¨ãƒ‘ãƒƒã‚¯ã‚’å–å¾—
            const packs = await packService.getAllPacks();
            set({ packs });
            console.log(`âœ… [PackStore] Loaded ${packs.length} packs from DB.`);
        } catch (error) {
            console.error('Failed to load packs:', error);
            // å¤±æ•—æ™‚ã¯packsã‚’ç©ºã®ã¾ã¾ã«ã™ã‚‹
        }
    },
    
    createPack: async (newPackData) => { // ğŸ’¡ asyncã«å¤‰æ›´
        const newPack: Pack = {
            ...newPackData,
            packId: generatePackId(),
            totalCards: 0, 
            isOpened: false, 
            rarityConfig: newPackData.rarityConfig.length > 0 ? newPackData.rarityConfig : DEFAULT_RARITY_CONFIG, 
        };
        
        // ğŸ› ï¸ DBã¸ã®æ›¸ãè¾¼ã¿
        // packServiceã®createPackã¯DBã§ç”Ÿæˆã•ã‚ŒãŸIDã‚’è¿”ã™
        const newId = await packService.createPack(newPack);
        
        set(state => ({
            // DBã§ç¢ºå®šã—ãŸIDã§ã‚¹ãƒˆã‚¢ã«åæ˜ 
            packs: [...state.packs, { ...newPack, packId: newId }],
        }));
        console.log(`ãƒ‘ãƒƒã‚¯ã‚’ä½œæˆ: ${newPack.name} (ID: ${newId})`);
    },
    
    updatePack: async (updatedPack) => { // ğŸ’¡ asyncã«å¤‰æ›´
        // ğŸ› ï¸ DBã¸ã®æ›¸ãè¾¼ã¿
        await packService.updatePack(updatedPack.packId, updatedPack);
        
        set(state => ({
            packs: state.packs.map(p => 
                p.packId === updatedPack.packId ? updatedPack : p
            ),
        }));
        console.log(`ãƒ‘ãƒƒã‚¯ã‚’æ›´æ–°: ${updatedPack.name}`);
    },
    
    deletePack: async (packId) => { // ğŸ’¡ asyncã«å¤‰æ›´
        // ğŸ› ï¸ DBã‹ã‚‰å‰Šé™¤
        await packService.deletePack(packId);
        
        set(state => ({
            packs: state.packs.filter(p => p.packId !== packId),
        }));
        console.log(`ãƒ‘ãƒƒã‚¯ã‚’å‰Šé™¤: ${packId}`);
    },
}));