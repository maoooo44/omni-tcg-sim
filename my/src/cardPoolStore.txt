// src/stores/cardPoolStore.ts
import { create } from 'zustand';
import { cardPoolService } from '../services/card-pool/cardPoolService'; 

// ユーザーのカード資産の状態
export interface CardPoolState {
    // key: cardId (string), value: 所有枚数 (number)
    ownedCards: Map<string, number>;
    totalOwnedCards: number;

    // --- アクション ---
    /** DBからデータをロードしてストアを初期化 */
    loadCardPool: () => Promise<void>; 
    /** パック開封などによってカードを追加 */
    addCards: (cards: { cardId: string, count: number, packId: string }[]) => Promise<void>;
    /** デッキ構築などによってカードの枚数を更新 */
    setCardCount: (cardId: string, count: number) => Promise<void>;
    /** カードプールを完全にリセット（デバッグ用） */
    resetPool: () => Promise<void>; // 💡 Promise<void> に変更
    /** 💡 ZIPインポート: カードプールデータをDBとストアに上書きする */
    importCardPool: (importedOwnedCards: Map<string, number>) => Promise<void>;
}

const initialState = {
    ownedCards: new Map<string, number>(), // 型を明示
    totalOwnedCards: 0,
};

// 💡 get を _get に変更し、未使用の警告を回避
export const useCardPoolStore = create<CardPoolState>((set, _get) => ({
    ...initialState,
    
    // 💡 実装1: DBからカードプールをロードする
    loadCardPool: async () => {
        try {
            // DBからMap形式でデータを取得
            const ownedCards = await cardPoolService.getOwnedCardsMap();
            
            // 総枚数を計算
            let newTotal = 0;
            ownedCards.forEach(count => {
                newTotal += count;
            });

            // ストアに反映
            set({ 
                ownedCards, 
                totalOwnedCards: newTotal 
            });
            console.log(`✅ [CardPoolStore] Loaded ${ownedCards.size} unique cards, total ${newTotal} cards.`);

        } catch (error) {
            console.error('Failed to load card pool:', error);
            // 失敗時は初期状態を維持
        }
    },

    // 💡 実装2: カードを追加し、DBに保存する
    addCards: async (cards) => {
        const countsToUpdate = new Map<string, number>();

        set(state => {
            const newOwnedCards = new Map(state.ownedCards);
            let newTotal = state.totalOwnedCards;

            cards.forEach(({ cardId, count }) => {
                // 新しい所有枚数を計算
                const currentCount = newOwnedCards.get(cardId) || 0;
                const newCount = currentCount + count;
                
                // ストアのMapを更新
                newOwnedCards.set(cardId, newCount);
                // DBに更新すべきMapにも追加
                countsToUpdate.set(cardId, newCount);
                
                newTotal += count;
            });

            return { 
                ownedCards: newOwnedCards, 
                totalOwnedCards: newTotal 
            };
        });

        // 🛠️ DBへ変更を保存 (非同期)
        try {
            // cardPoolService.bulkUpdateCardCounts は Map のデータをそのまま DB に反映
            await cardPoolService.bulkUpdateCardCounts(countsToUpdate); 
        } catch (error) {
            console.error('Failed to save card pool after adding cards:', error);
            // 致命的なエラーだが、ストアは更新されているため、エラーログのみ
        }
    },

    // 💡 実装3: カード枚数を設定し、DBに保存する（売却や編集用）
    setCardCount: async (cardId, count) => {
        // count は 0 以上に制限
        const newCount = Math.max(0, count);

        set(state => {
            const newOwnedCards = new Map(state.ownedCards);
            let newTotal = state.totalOwnedCards;

            // 古い枚数を取得
            const oldCount = newOwnedCards.get(cardId) || 0;
            
            // 総枚数を更新
            newTotal = newTotal - oldCount + newCount;

            if (newCount > 0) {
                newOwnedCards.set(cardId, newCount);
            } else {
                newOwnedCards.delete(cardId);
            }

            return { 
                ownedCards: newOwnedCards, 
                totalOwnedCards: newTotal 
            };
        });

        // 🛠️ DBへ変更を保存 (非同期)
        try {
            // 1枚の更新も bulkUpdateCardCounts で処理可能
            const countsToUpdate = new Map<string, number>([[cardId, newCount]]);
            await cardPoolService.bulkUpdateCardCounts(countsToUpdate); 
        } catch (error) {
            console.error('Failed to save card pool after setting count:', error);
        }
    },

    // 💡 実装4: カードプール全体をリセットする
    resetPool: async () => {
        // DBからも削除する
        // 🛠️ DBリセットを非同期にし、確実に完了を待つ
        await cardPoolService.bulkUpdateCardCounts(new Map()); // 空のMapでDBをリセット
        set(initialState);
        console.log("Card pool reset completed.");
    },

    // --------------------------------------------------
    // 💡 ZIPインポート機能
    // --------------------------------------------------

    importCardPool: async (importedOwnedCards) => {
        // 1. DBを完全に上書き (クリアしてから新しいデータをセット)
        try {
            // 💡 既存の bulkUpdateCardCounts を再利用し、空のMapでクリア後、新しいデータを追加
            await cardPoolService.bulkUpdateCardCounts(new Map()); // DBをクリア
            await cardPoolService.bulkUpdateCardCounts(importedOwnedCards); // 新しいデータを追加
        } catch (error) {
            console.error("Failed to overwrite card pool in DB:", error);
            throw new Error("カードプールのDB上書きに失敗しました。");
        }
        
        // 2. Zustandストアの状態を更新
        let newTotal = 0;
        importedOwnedCards.forEach(count => {
            newTotal += count;
        });

        set({
            ownedCards: importedOwnedCards, 
            totalOwnedCards: newTotal
        });
        console.log(`✅ Card pool imported. Total: ${newTotal} cards.`);
    },
}));