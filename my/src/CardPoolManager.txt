// src/features/card-pool/CardPoolManager.tsx

import React, { useMemo } from 'react'; 
import { 
    Box, Typography, Grid, Paper, Select, MenuItem, FormControl, 
    InputLabel, TextField, Pagination, ToggleButtonGroup, ToggleButton, 
    Button, Alert, Divider, Chip 
} from '@mui/material';
import SearchIcon from '@mui/icons-material/Search';
import CloseIcon from '@mui/icons-material/Close';
import SortIcon from '@mui/icons-material/Sort';

import { useCardPoolDisplay, CARDS_PER_PAGE } from './hooks/useCardPoolDisplay';
import type { OwnedCardDisplay, CardPoolFilters, SortKey } from './hooks/useCardPoolDisplay'; 
// ğŸ› ï¸ ä¿®æ­£: CardThumbnail ã®ä»£ã‚ã‚Šã« OpenerCard ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (TS2307 è§£æ¶ˆ)
import OpenerCard from '../../components/OpenerCard'; 
import { useShallow } from 'zustand/react/shallow';
import { useUserDataStore } from '../../stores/userDataStore'; 

// OwnedCardItem ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®šç¾©
interface OwnedCardProps {
    card: OwnedCardDisplay;
    isDTCGEnabled: boolean;
}
const OwnedCardItem: React.FC<OwnedCardProps> = ({ card, isDTCGEnabled }) => {
    return (
        <Box sx={{ position: 'relative', width: '100%', maxWidth: 150 }}>
            {/* ğŸ› ï¸ ä¿®æ­£: OpenerCard ã‚’ä½¿ç”¨ã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºç”¨ã« Props ã‚’è¨­å®š */}
            <OpenerCard 
                cardData={card} 
                isRevealed={true} // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯å¸¸ã«è¡¨é¢ã‚’è¡¨ç¤º
                cardBackUrl={''} // æœªä½¿ç”¨ã ãŒ OpenerCard ã®Propsè¦ä»¶ã‚’æº€ãŸã™
                delay={0}        // æœªä½¿ç”¨ã ãŒ OpenerCard ã®Propsè¦ä»¶ã‚’æº€ãŸã™
            />
            {isDTCGEnabled && (
                <Chip 
                    label={`x${card.count}`} 
                    color="primary" 
                    size="small" 
                    sx={{ 
                        position: 'absolute', 
                        bottom: 4, 
                        right: 4, 
                        bgcolor: 'rgba(0,0,0,0.7)', 
                        color: 'white',
                        fontWeight: 'bold'
                    }} 
                />
            )}
        </Box>
    );
};


const CardPoolManager: React.FC = () => {
    
    const isDTCGEnabled = useUserDataStore(useShallow(state => state.isDTCGEnabled));

    const {
        loading,
        error,
        filteredCards,
        filter,
        setFilter,
        currentPage,
        totalPages,
        setCurrentPage,
        sortKey,
        setSortKey,
        sortOrder,
        setSortOrder,
        resetCollection,
    } = useCardPoolDisplay();
    
    const totalCount = useMemo(() => filteredCards.length, [filteredCards]);
    const startIndex = (currentPage - 1) * CARDS_PER_PAGE;
    const endIndex = startIndex + CARDS_PER_PAGE;
    const cardsOnPage = useMemo(() => filteredCards.slice(startIndex, endIndex), [filteredCards, startIndex, endIndex]);

    const handleFilterChange = (key: keyof CardPoolFilters, value: string | number | null) => {
        setFilter({ [key]: value });
        setCurrentPage(1); 
    };

    const handleClearSearch = () => {
        setFilter({ search: '' });
        setCurrentPage(1);
    };

    const handleSortChange = (
        _event: React.MouseEvent<HTMLElement>,
        newSortKey: string | null,
    ) => {
        if (newSortKey && newSortKey === sortKey) {
            setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
        } else if (newSortKey) {
            setSortKey(newSortKey as SortKey);
            setSortOrder('asc');
        }
    };
    
    if (loading) {
        return (
            <Box sx={{ display: 'flex', justifyContent: 'center', p: 4 }}>
                <Typography>ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</Typography>
            </Box>
        );
    }

    if (error) {
        return (
            <Alert severity="error" sx={{ my: 2 }}>
                ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: {error.message}
            </Alert>
        );
    }

    return (
        <Box sx={{ flexGrow: 1, p: 2 }}>
            <Typography variant="h4" gutterBottom>
                ã‚«ãƒ¼ãƒ‰ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
            </Typography>
            <Divider sx={{ mb: 3 }} />

            <Paper elevation={2} sx={{ p: 3, mb: 3 }}>
                <Typography variant="h6" gutterBottom>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ä¸¦ã³æ›¿ãˆ</Typography>
                
                {/* Grid container */}
                <Grid container spacing={2}>
                    
                    <Grid size={{ xs: 12, md: 4 }}> 
                        <Box sx={{ display: 'flex', alignItems: 'flex-end', gap: 1 }}>
                            <SearchIcon color="action" sx={{ mb: 1.5 }} />
                            <TextField 
                                label="ã‚«ãƒ¼ãƒ‰åã§æ¤œç´¢"
                                fullWidth
                                value={filter.search || ''}
                                onChange={(e) => handleFilterChange('search', e.target.value)}
                            />
                            {filter.search && (
                                <Button onClick={handleClearSearch} size="small" sx={{ mb: 0.5 }}>
                                    <CloseIcon />
                                </Button>
                            )}
                        </Box>
                    </Grid>
                    
                    <Grid size={{ xs: 6, md: 2 }}>
                        <FormControl fullWidth>
                            <InputLabel>ãƒ‘ãƒƒã‚¯</InputLabel>
                            <Select
                                value={filter.packId || 'all'}
                                label="ãƒ‘ãƒƒã‚¯"
                                onChange={(e) => handleFilterChange('packId', e.target.value === 'all' ? null : e.target.value)}
                            >
                                <MenuItem value="all">å…¨ã¦</MenuItem>
                                <MenuItem value="pack-a">ãƒ‘ãƒƒã‚¯A</MenuItem> 
                            </Select>
                        </FormControl>
                    </Grid>
                    
                    <Grid size={{ xs: 6, md: 2 }}>
                        <FormControl fullWidth>
                            <InputLabel>ãƒ¬ã‚¢ãƒªãƒ†ã‚£</InputLabel>
                            <Select
                                value={filter.rarity || 'all'}
                                label="ãƒ¬ã‚¢ãƒªãƒ†ã‚£"
                                onChange={(e) => handleFilterChange('rarity', e.target.value === 'all' ? null : e.target.value)}
                            >
                                <MenuItem value="all">å…¨ã¦</MenuItem>
                                <MenuItem value="Common">Common</MenuItem>
                                <MenuItem value="Rare">Rare</MenuItem>
                            </Select>
                        </FormControl>
                    </Grid>
                    
                    <Grid size={{ xs: 12, md: 4 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center', height: '100%', gap: 1 }}>
                            <SortIcon color="action" />
                            <ToggleButtonGroup
                                value={sortKey} 
                                exclusive
                                onChange={handleSortChange}
                                size="small"
                                aria-label="card sort"
                                sx={{ flexGrow: 1 }}
                            >
                                <ToggleButton value="name" aria-label="name">
                                    åå‰
                                </ToggleButton>
                                <ToggleButton value="pack" aria-label="pack">
                                    ãƒ‘ãƒƒã‚¯
                                </ToggleButton>
                                {isDTCGEnabled && (
                                    <ToggleButton value="count" aria-label="count">
                                        æšæ•°
                                    </ToggleButton>
                                )}
                            </ToggleButtonGroup>
                            
                            {sortKey && (
                                <Button 
                                    onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                                    size="small"
                                >
                                    {sortOrder === 'asc' ? 'æ˜‡é †' : 'é™é †'}
                                </Button>
                            )}
                        </Box>
                    </Grid>

                    <Grid size={{ xs: 12 }} sx={{ mt: 2 }}>
                        <Button 
                            variant="outlined" 
                            color="error" 
                            onClick={resetCollection} 
                            size="small"
                        >
                            ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                        </Button>
                    </Grid>

                </Grid>
            </Paper>

            <Typography variant="h6" sx={{ mt: 3 }}>
                åˆè¨ˆ {totalCount} ä»¶ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºä¸­
            </Typography>

            {/* ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */}
            <Box sx={{ mt: 3, minHeight: 400 }}>
                {totalCount === 0 ? (
                    <Alert severity="info">
                        è¡¨ç¤ºã§ãã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ãƒ‘ãƒƒã‚¯ã‚’é–‹å°ã—ã¦ãã ã•ã„ã€‚
                    </Alert>
                ) : (
                    <>
                        {/* Grid container ã¯ãã®ã¾ã¾ */}
                        <Grid container spacing={2} justifyContent="center">
                            {cardsOnPage.map((card) => (
                                <Grid 
                                    size={{ xs: 6, sm: 4, md: 2 }} 
                                    key={card.cardId} 
                                    sx={{ display: 'flex', justifyContent: 'center' }}
                                >
                                    <OwnedCardItem card={card} isDTCGEnabled={isDTCGEnabled} />
                                </Grid>
                            ))}
                        </Grid>


                        {/* Pagination */}
                        {totalPages > 1 && (
                            <Box sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>
                                <Pagination 
                                    count={totalPages}
                                    page={currentPage}
                                    onChange={(_e, page) => setCurrentPage(page)}
                                    color="primary"
                                    showFirstButton 
                                    showLastButton 
                                />
                            </Box>
                        )}
                    </>
                )}
            </Box>
        </Box>
    );
};

export default CardPoolManager;