// src/service/card-pool/cardPoolService.ts
import { db } from "../database/db";
import type { DBCardPool } from '../../models/db-types'; // ğŸ’¡ DBCardPool å‹ã®åˆ©ç”¨ã‚’å†é–‹

/**
 * IndexedDB (Dexie) ã® 'cardPool' ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã™ã‚‹æ“ä½œã‚’æ‰±ã†ã‚µãƒ¼ãƒ“ã‚¹
 */
export const cardPoolService = {

    /**
     * ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«å…¨ä½“ã‚’DBã‹ã‚‰å–å¾—ã™ã‚‹ã€‚
     * @returns cardIdã‚’ã‚­ãƒ¼ã€æ‰€æœ‰æšæ•°ã‚’å€¤ã¨ã™ã‚‹Map
     */
    async getOwnedCardsMap(): Promise<Map<string, number>> {
        try {
            // ğŸ’¡ å‹ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€db.cardPool.toArray() ã®å‹ã‚’æ˜ç¤º
            const dbEntries: DBCardPool[] = await db.cardPool.toArray();
            const cardMap = new Map<string, number>();

            dbEntries.forEach(entry => {
                // key: cardId, value: count ã‚’ãƒãƒƒãƒ—ã«æ ¼ç´
                cardMap.set(entry.cardId, entry.count);
            });

            return cardMap;
        } catch (error) {
            console.error("Failed to load card pool from DB:", error);
            // å¤±æ•—æ™‚ã¯ç©ºã®ãƒãƒƒãƒ—ã‚’è¿”ã™
            return new Map();
        }
    },

    /**
     * æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰IDã®æ‰€æœ‰æšæ•°ã‚’DBä¸Šã§æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆã™ã‚‹ã€‚
     * @param cardId - æ›´æ–°ã¾ãŸã¯ä½œæˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ID
     * @param newCount - æ–°ã—ã„æ‰€æœ‰æšæ•° (0ã®å ´åˆã¯å‰Šé™¤)
     */
    async updateCardCount(cardId: string, newCount: number): Promise<void> {
        // ... æ—¢å­˜ã®å®Ÿè£…ã¯å¤‰æ›´ãªã—
        try {
            if (newCount > 0) {
                // æšæ•°ãŒ1ä»¥ä¸Šã®å ´åˆ: æ›´æ–°ã¾ãŸã¯è¿½åŠ  (put)
                await db.cardPool.put({ 
                    cardId: cardId, 
                    count: newCount 
                } as DBCardPool); // ğŸ’¡ å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            } else {
                // æšæ•°ãŒ0ã®å ´åˆ: å‰Šé™¤
                await db.cardPool.delete(cardId);
            }
        } catch (error) {
            console.error(`Failed to update count for Card ID ${cardId}:`, error);
            throw new Error("ã‚«ãƒ¼ãƒ‰è³‡ç”£ã®DBæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    },

    /**
     * è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰ã®æ‰€æœ‰æšæ•°ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ä¸€æ‹¬æ›´æ–°ã™ã‚‹ã€‚
     * @param updates - cardIdã‚’ã‚­ãƒ¼ã€æ–°ã—ã„æ‰€æœ‰æšæ•°ã‚’å€¤ã¨ã™ã‚‹Map
     */
    async bulkUpdateCardCounts(updates: Map<string, number>): Promise<void> {
        // ... æ—¢å­˜ã®å®Ÿè£…ã¯å¤‰æ›´ãªã—
        try {
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã€ä¸€é€£ã®æ“ä½œã‚’åŸå­çš„ã«è¡Œã†
            await db.transaction('rw', db.cardPool, async () => {
                for (const [cardId, newCount] of updates.entries()) {
                    if (newCount > 0) {
                        await db.cardPool.put({ 
                            cardId: cardId, 
                            count: newCount 
                        } as DBCardPool); // ğŸ’¡ å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                    } else {
                        await db.cardPool.delete(cardId);
                    }
                }
            });
        } catch (error) {
            console.error("Failed to bulk update card pool:", error);
            throw new Error("ã‚«ãƒ¼ãƒ‰è³‡ç”£ã®ä¸€æ‹¬DBæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    },
    
    // ----------------------------------------------------
    // ğŸ’¡ æ–°è¦è¿½åŠ : ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«å…¨ä½“ã‚’DBã«ä¿å­˜ã™ã‚‹æ±ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
    // ----------------------------------------------------
    /**
     * ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«å…¨ä½“ã‚’DBã«ä¿å­˜ã™ã‚‹ï¼ˆMapã‚’IndexedDBå½¢å¼ã«å¤‰æ›ã—ã¦ä¿å­˜ï¼‰ã€‚
     * å…¨ä»¶ã‚’ä¸Šæ›¸ãã™ã‚‹ã®ã§ã¯ãªãã€æ›´æ–°åˆ†ã®ã¿ã‚’åæ˜ ã—ã¾ã™ã€‚
     * @param ownedCards - ä¿å­˜ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã®Map
     */
    async saveCardPool(_ownedCards: Map<string, number>): Promise<void> {
        // ğŸš¨ æ³¨æ„: æ—¢å­˜ã®DBãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã®å·®åˆ†ã‚’å–ã‚‹è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ãŸã‚ã€
        // ğŸ’¡ ã‚·ãƒ³ãƒ—ãƒ«ã« bulkUpdateCardCounts ã‚’å†åˆ©ç”¨ã—ã¾ã™ã€‚
        //    ãŸã ã—ã€ã“ã‚Œã¯Mapã«å«ã¾ã‚Œãªã„ã‚«ãƒ¼ãƒ‰ã‚’DBã‹ã‚‰å‰Šé™¤ã—ãªã„ãŸã‚ã€
        //    å³å¯†ã«ã¯ã€Œã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ã‚’ãã®ã¾ã¾DBã«åæ˜ ã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        //    ä»Šå›ã¯ã€æ›´æ–°ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã®ã¿ã‚’DBã«åæ˜ ã™ã‚‹æˆ¦ç•¥ã‚’æ¡ç”¨ã—ã¾ã™ã€‚
        
        // ownedCardsãŒå¤‰æ›´å¾Œã®çŠ¶æ…‹å…¨ä½“ã‚’è¡¨ã™ãŸã‚ã€ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒˆãƒªã‚’ put/delete ã§å‡¦ç†ã—ã¾ã™ã€‚
        // æ—¢å­˜ã® bulkUpdateCardCounts ãŒã“ã®æ©Ÿèƒ½ã‚’ã™ã§ã«æº€ãŸã—ã¦ã„ã¾ã™ã€‚
        // ğŸ’¡ ã—ãŸãŒã£ã¦ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã€storeå´ã§ bulkUpdateCardCounts ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
        
        // å³å¯†ã«ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ã‚’DBã«åæ˜ ã—ãŸã„å ´åˆã¯ã€DBã®å…¨ä»¶å‰Šé™¤å¾Œã«å…¨ä»¶putãŒå¿…è¦ã§ã™ãŒã€
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®æ‡¸å¿µã‹ã‚‰ã€ä»Šå›ã¯ bulkUpdateCardCounts ã‚’å†åˆ©ç”¨ã—ã¾ã™ã€‚
        
        // ğŸ’¡ çµè«–: æ–°è¦ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸è¦ã¨ã—ã€storeã‹ã‚‰ bulkUpdateCardCounts ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
    }

};