// src/hooks/useInitialLoad.ts

import { useEffect, useState } from 'react';
import { useCardData } from './useCardData'; // ğŸ’¡ å¿…é ˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { usePackStore } from '../stores/packStore';
import { useCardPoolStore } from '../stores/cardPoolStore';
import { useUserDataStore } from '../stores/userDataStore';
import { useCurrencyStore } from '../stores/currencyStore';
// ğŸ’¡ Zustandã‚¹ãƒˆã‚¢ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‹ã‚’å®šç¾© (getState()ã§ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã™ãŸã‚)
import type { PackState } from '../stores/packStore';
import type { CardPoolState } from '../stores/cardPoolStore';
import type { UserDataState } from '../stores/userDataStore';
import type { CurrencyState } from '../stores/currencyStore';

// ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒã¤ã‚¹ãƒˆã‚¢ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’çµ±åˆ
type StoreActions = Pick<PackState, 'loadPacks'> & 
                    Pick<CardPoolState, 'loadCardPool'> & 
                    Pick<UserDataState, 'loadUserData'> &
                    Pick<CurrencyState, 'loadCurrency'>;

/**
 * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸèµ·å‹•æ™‚ã«å¿…è¦ãªå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã€ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ãƒƒã‚¯
 * @returns {boolean} å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰ true
 */
export const useInitialLoad = (): boolean => {
    // ğŸ“Œ ä¿®æ­£: å­˜åœ¨ã—ãªã„ 'isLoaded' ã‚’å‚ç…§ã™ã‚‹ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°ã‚’ä¿®æ­£
    // useCardData() ã®æˆ»ã‚Šå€¤ã§ã‚ã‚‹ 'isCardDataLoaded' ã‚’ç›´æ¥ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
    const { isCardDataLoaded } = useCardData(); 
    const [isStoresLoaded, setIsStoresLoaded] = useState(false);
    
    useEffect(() => {
        if (!isCardDataLoaded) {
            return; 
        }

        const loadAllStores = async () => {
            
            // ğŸ“Œ storeã®getState()ã®çµæœã‚’ 'unknown' çµŒç”±ã§ StoreActions ã«ã‚­ãƒ£ã‚¹ãƒˆ
            const { loadPacks } = usePackStore.getState() as unknown as StoreActions;
            const { loadCardPool } = useCardPoolStore.getState() as unknown as StoreActions;
            const { loadUserData } = useUserDataStore.getState() as unknown as StoreActions;
            const { loadCurrency } = useCurrencyStore.getState() as unknown as StoreActions;

            try {
                console.log("Starting initial store data load...");
                
                await Promise.all([
                    loadPacks(), 
                    loadUserData(),
                    loadCardPool(),
                    loadCurrency(),
                ]);

                setIsStoresLoaded(true);
                console.log('âœ… All initial store data loading completed.');

            } catch (error) {
                console.error('åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                setIsStoresLoaded(true);
            }
        };
        
        loadAllStores();
        
    }, [isCardDataLoaded]); 

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸã‚‰ true ã‚’è¿”ã™
    return isCardDataLoaded && isStoresLoaded;
};