// src/components/PackCardList.tsx

import React from 'react';
import { Button, Grid, Box, Typography, Card, CardContent, CardActionArea, CardMedia } from '@mui/material';
import AddIcon from '@mui/icons-material/Add';
import { useShallow } from 'zustand/react/shallow';
import { useCardStore } from '../stores/cardStore';
import { generateUUID } from '../utils/uuidUtils';
import type { Card as CardType } from '../models/card';

// ä»®å®š: CardEditModalã‚’é–‹ããŸã‚ã®Propsã‚’å®šç¾©
interface PackCardListProps {
    packId: string;
    isEditable: boolean;
    // ğŸ’¡ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ããŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå®Ÿè£…ã¯PackEditPageå´ï¼‰
    onOpenEditModal: (card: CardType | null) => void;
}

const CARD_GRID_WIDTH = 150; // ã‚«ãƒ¼ãƒ‰ä¸€æšã®å¹…ã‚’å®šç¾©

const PackCardList: React.FC<PackCardListProps> = ({ packId, isEditable, onOpenEditModal }) => {
    // packIdã«ç´ã¥ãã‚«ãƒ¼ãƒ‰ã®ã¿ã‚’å–å¾—
    const cardsInPack = useCardStore(useShallow(state => 
        state.cards.filter(card => card.packId === packId)
    ));
    
    // æ–°è¦ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†
    const handleAddNewCard = () => {
        if (!isEditable) return;

        // ç©ºã®Cardã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const newCard: CardType = {
            cardId: generateUUID(),
            packId: packId,
            name: 'æ–°ã—ã„ã‚«ãƒ¼ãƒ‰',
            imageUrl: '',
            rarity: '',
            userCustom: {},
        };

        // ã‚¹ãƒˆã‚¢ã«ä¸€æ—¦è¿½åŠ ã¯ã›ãšã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç·¨é›†ãƒ»ä¿å­˜ã•ã›ã‚‹ï¼ˆä»Šå›ã¯å³æ™‚ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸ï¼‰
        onOpenEditModal(newCard);
    };
    
    // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ãŸå‡¦ç†
    const handleSelectCard = (card: CardType) => {
        if (isEditable) {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚: ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            onOpenEditModal(card);
        } else {
            // éç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚: è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (TODO)
            alert(`ã‚«ãƒ¼ãƒ‰è©³ç´°è¡¨ç¤º (ID: ${card.cardId}) - TODO`);
        }
    };

    return (
        <Box sx={{ flexGrow: 1 }}>
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
                <Typography variant="h5">åéŒ²ã‚«ãƒ¼ãƒ‰ ({cardsInPack.length}æš)</Typography>
                {isEditable && (
                    <Button 
                        variant="contained" 
                        startIcon={<AddIcon />} 
                        onClick={handleAddNewCard}
                    >
                        æ–°è¦ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                    </Button>
                )}
            </Box>

            <Box 
                sx={{ 
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ã‚¹ã‚¿ãƒ UIã®ç¸¦é•·ã‚’é˜²ããŸã‚ã€ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹
                    maxHeight: '70vh', 
                    overflowY: 'auto', 
                    p: 1, 
                    border: '1px solid', 
                    borderColor: 'grey.300',
                    borderRadius: 1
                }}
            >
                {/* åéŒ²ã‚«ãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º */}
                <Grid container spacing={2}>
                    {cardsInPack.map(card => (
                        <Grid key={card.cardId}>
                            <Card 
                                sx={{ 
                                    width: CARD_GRID_WIDTH, 
                                    cursor: 'pointer',
                                    boxShadow: 1, 
                                }}
                                onClick={() => handleSelectCard(card)}
                            >
                                <CardActionArea>
                                    <CardMedia
                                        component="img"
                                        // imageUrlãŒç©ºã®å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
                                        image={card.imageUrl || 'https://via.placeholder.com/150x210?text=Card+Image'} 
                                        alt={card.name}
                                        sx={{ height: 210, objectFit: 'cover' }}
                                    />
                                    <CardContent sx={{ p: 1, '&:last-child': { pb: 1 } }}>
                                        <Typography variant="subtitle2" noWrap>{card.name}</Typography>
                                        <Typography variant="caption" color="text.secondary">{card.rarity}</Typography>
                                    </CardContent>
                                </CardActionArea>
                            </Card>
                        </Grid>
                    ))}
                    
                    {cardsInPack.length === 0 && (
                        <Grid>
                            <Box sx={{ p: 2, m: 1, border: '1px dashed grey', borderRadius: 1, width: CARD_GRID_WIDTH }}>
                                <Typography variant="body2" color="text.secondary">
                                    ã‚«ãƒ¼ãƒ‰ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                                </Typography>
                            </Box>
                        </Grid>
                    )}

                </Grid>
            </Box>
        </Box>
    );
};

export default PackCardList;