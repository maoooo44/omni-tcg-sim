// src/stores/currencyStore.ts (å…¨æ–‡)

import { create } from 'zustand';
// ğŸ’¡ IndexedDBé€£æºã®ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ï¼‰
import { currencyService } from '../services/currency/currencyService'; 

export interface CurrencyState {
    coins: number;
    
    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    /** åˆæœŸãƒ­ãƒ¼ãƒ‰ */
    loadCurrency: () => Promise<void>;
    /** é€šè²¨ã®åŠ ç®— */
    addCoins: (amount: number) => Promise<void>;
    /** é€šè²¨ã®æ¸›ç®—ï¼ˆè³¼å…¥å‡¦ç†ï¼‰ */
    spendCoins: (amount: number) => Promise<boolean>; // æˆåŠŸ/å¤±æ•—ã‚’è¿”ã™
    /** ãƒ‡ãƒãƒƒã‚°ç”¨ãƒªã‚»ãƒƒãƒˆ */
    resetCurrency: () => Promise<void>; // ğŸ’¡ ä¿®æ­£: éåŒæœŸå‡¦ç†ã‚’ä¼´ã†ãŸã‚ Promise<void> ã«å¤‰æ›´
}

const INITIAL_COINS = 5000; // åˆæœŸæ‰€æŒé‡‘ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
const DEFAULT_CURRENCY_STATE = { coins: INITIAL_COINS };

export const useCurrencyStore = create<CurrencyState>((set, get) => ({
    coins: INITIAL_COINS,
    
    // ğŸ’¡ å®Ÿè£…1: DBã‹ã‚‰é€šè²¨ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¹ãƒˆã‚¢ã‚’åˆæœŸåŒ–
    loadCurrency: async () => {
        try {
            // currencyService.loadCoins() ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const coins = await currencyService.loadCoins();
            // DBãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
            const loadedCoins = coins !== undefined ? coins : INITIAL_COINS;
            
            set({ coins: loadedCoins });
            console.log(`âœ… [CurrencyStore] Loaded ${loadedCoins} coins.`);
        } catch (error) {
            console.error('Failed to load currency:', error);
        }
    },
    
    // ğŸ’¡ å®Ÿè£…2: é€šè²¨ã®åŠ ç®—ã¨DBä¿å­˜
    addCoins: async (amount) => {
        // ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°
        set(state => ({ coins: state.coins + amount }));
        
        // DBã«ä¿å­˜
        await currencyService.saveCoins(get().coins);
        console.log(`+${amount} coins added. New balance: ${get().coins}`);
    },

    // ğŸ’¡ å®Ÿè£…3: é€šè²¨ã®æ¸›ç®—ã¨DBä¿å­˜
    spendCoins: async (amount) => {
        const currentCoins = get().coins;
        
        if (currentCoins < amount) {
            return false; // å¤±æ•—
        }
        
        // 1. ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°
        set(state => ({ coins: state.coins - amount }));
        
        // 2. DBã«ä¿å­˜
        await currencyService.saveCoins(get().coins);

        console.log(`-${amount} coins spent. New balance: ${get().coins}`);
        return true; // æˆåŠŸ
    },

    // ğŸ’¡ å®Ÿè£…4: ãƒªã‚»ãƒƒãƒˆã¨DBä¿å­˜
    resetCurrency: async () => {
        // 1. DBã«åˆæœŸå€¤ã‚’ä¿å­˜ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
        await currencyService.saveCoins(INITIAL_COINS);
        // 2. ã‚¹ãƒˆã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
        set(DEFAULT_CURRENCY_STATE); 
        console.log('Currency reset to default.');
    },
}));