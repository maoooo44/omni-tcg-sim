// src/stores/userDataStore.ts (ä¿®æ­£)

import { create } from 'zustand';
// ğŸ’¡ æ–°è¦ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { userSettingsService, type PersistedUserSettings } from '../services/user-logic/userSettingsService';

// ğŸš¨ å‰Šé™¤: é€šè²¨ç®¡ç†ã¯currencyStoreã«å®Œå…¨ã«å§”è­²ã™ã‚‹ãŸã‚ã€DEFAULT_COINSã‚’å‰Šé™¤
// const DEFAULT_COINS = 5000;

// ğŸ“Œ ä¿®æ­£1: UserDataã®çŠ¶æ…‹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµ±åˆã—ãŸå‹å®šç¾©
export interface UserDataState {
    // ğŸš¨ å‰Šé™¤: coinsã‚’å‰Šé™¤ (currencyStoreã«ç§»å‹•)
    // coins: number;              
    isDTCGEnabled: boolean;     
    isGodMode: boolean;         
    cheatCount: number;         
    
    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    loadUserData: () => Promise<void>; 
    // ğŸš¨ å‰Šé™¤: setCoins, updateCoins ã‚’å‰Šé™¤ (currencyStoreã«ç§»å‹•)
    // setCoins: (amount: number) => void;
    // updateCoins: (delta: number) => void;
    setDTCGMode: (isEnabled: boolean) => Promise<void>; 
    setGodMode: (isGMode: boolean) => Promise<void>;   
    // ğŸ’¡ importUserData ã‹ã‚‰ coins ã‚’å‰Šé™¤
    importUserData: (data: Omit<{ coins: number, isDTCGEnabled: boolean, isGodMode: boolean, cheatCount: number }, 'coins'>) => void;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸå€¤ (çŠ¶æ…‹éƒ¨åˆ†ã®ã¿)
const initialState = {
    // ğŸš¨ å‰Šé™¤: coinsã‚’å‰Šé™¤ (currencyStoreã«ç§»å‹•)
    // coins: DEFAULT_COINS,
    isDTCGEnabled: true, 
    isGodMode: false,
    cheatCount: 0,
};

// DBä¿å­˜ã®ãŸã‚ã®æ°¸ç¶šåŒ–å¯èƒ½ãªçŠ¶æ…‹ã‚’æŠ½å‡ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
const getPersistableState = (state: UserDataState): PersistedUserSettings => ({
    isDTCGEnabled: state.isDTCGEnabled,
    isGodMode: state.isGodMode,
    cheatCount: state.cheatCount,
});


export const useUserDataStore = create<UserDataState>((set, get) => ({
    // çŠ¶æ…‹ã®åˆæœŸå€¤ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰
    ...initialState,
    
    // ğŸ’¡ loadUserDataã®å®Ÿè£…: DBã‹ã‚‰è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¹ãƒˆã‚¢ã‚’åˆæœŸåŒ–
    loadUserData: async () => {
        try {
            const settings = await userSettingsService.loadSettings();
            if (settings) {
                // DBã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ãŸè¨­å®šã§ä¸Šæ›¸ã (coinsã¯loadã—ãªã„)
                set({ 
                    isDTCGEnabled: settings.isDTCGEnabled,
                    isGodMode: settings.isGodMode,
                    cheatCount: settings.cheatCount
                });
            }
            console.log("âœ… User data initialized.");
        } catch (error) {
            console.error('Failed to load user data:', error);
        }
    },
    
    // ğŸš¨ å‰Šé™¤: setCoins (currencyStoreã«ç§»å‹•)
    // setCoins: (amount) => {
    //     set({ coins: amount });
    // },
    
    // ğŸš¨ å‰Šé™¤: updateCoins (currencyStoreã«ç§»å‹•)
    // updateCoins: (delta) => {
    //     set(state => {
    //         const newCoins = Math.max(0, state.coins + delta);
    //         return { coins: newCoins };
    //     });
    // },

    // ğŸ’¡ setDTCGModeã®å®Ÿè£…: çŠ¶æ…‹æ›´æ–°å¾Œã«DBã«ä¿å­˜
    setDTCGMode: async (isEnabled) => {
        // 1. ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°
        set({ isDTCGEnabled: isEnabled }); 
        
        // 2. DBã«ä¿å­˜
        await userSettingsService.saveSettings(getPersistableState(get()));
        console.log(`DTCG Mode set to ${isEnabled}.`);
    },

    // ğŸ’¡ setGodModeã®å®Ÿè£…: çŠ¶æ…‹æ›´æ–°ã¨ãƒãƒ¼ãƒˆã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å¾Œã«DBã«ä¿å­˜
    setGodMode: async (isGMode) => {
        const currentGodMode = get().isGodMode;
        
        if (isGMode && !currentGodMode) {
            const { isDTCGEnabled, cheatCount } = get();
            
            let newCheatCount = cheatCount;
            if (isDTCGEnabled) {
                // DTCGãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ãƒãƒ¼ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™ãƒ­ã‚¸ãƒƒã‚¯
                newCheatCount = cheatCount + 1;
            }
            
            // 1. ã‚¹ãƒˆã‚¢ã‚’æ›´æ–°
            set({ 
                isGodMode: isGMode, 
                cheatCount: newCheatCount 
            });
            console.log(`God Mode Activated. Cheat Count: ${newCheatCount}`);

        } else {
            // 1. ã‚¹ãƒˆã‚¢ã‚’æ›´æ–° (God Modeã‚’è§£é™¤)
            set({ isGodMode: isGMode });
            console.log("God Mode Deactivated.");
        }
        
        // 2. DBã«ä¿å­˜
        await userSettingsService.saveSettings(getPersistableState(get()));
    },
    
    // ğŸ’¡ importUserDataã®ä¿®æ­£: coinsã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é™¤å¤–
    importUserData: async (data) => {
        set({ ...data });
        // ğŸ’¡ ZIPã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å ´åˆã€DBã«ã‚‚ä¿å­˜ã™ã¹ã
        await userSettingsService.saveSettings(getPersistableState(get()));
    },

}));