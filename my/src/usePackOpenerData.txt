// src/features/pack-opening/hooks/usePackOpenerData.ts (ã‚¨ãƒ©ãƒ¼è§£æ¶ˆç‰ˆ å…¨æ–‡)

import { useState, useEffect } from 'react';

import type { Pack } from '../../../models/pack'; //

import { usePackStore } from '../../../stores/packStore'; //
import { simulatePackOpening } from '../../../services/pack-logic/simulationUtils'; //
import { useCardPoolStore } from '../../../stores/cardPoolStore'; //
import { useCurrencyStore } from '../../../stores/currencyStore'; //
import { useShallow } from 'zustand/react/shallow'; //

// è­¦å‘Šãƒ­ã‚¸ãƒƒã‚¯å¯¾å¿œã®ãŸã‚ã€æ–°ã—ã„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®å‹ã‚’ä»®å®š
interface SimulationResult {
    results: { cardId: string, count: number }[];
    simulationWarning: string | null;
}

export const usePackOpenerData = (preselectedPackId?: string) => { 

    // packs ã¯ Pack[] å‹ [4, 5]
    const packs = usePackStore(state => state.packs);
    const isLoading = packs.length === 0;

    // ğŸ’¡ ä¿®æ­£1: selectedPack ã®å‹ã‚’ Pack | null ã«æ˜ç¤º
    const [selectedPack, setSelectedPack] = useState<Pack | null>(null);
    const [lastOpenedResults, setLastOpenedResults] = useState<{ cardId: string, count: number }[] | null>(null);
    
    // ğŸ’¡ ä¿®æ­£2: ã‚¨ãƒ©ãƒ¼/è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çŠ¶æ…‹ã«å‹ã‚’æ˜ç¤º
    const [purchaseError, setPurchaseError] = useState<string | null>(null); 
    const [simulationWarning, setSimulationWarning] = useState<string | null>(null); 

    const addCardsToPool = useCardPoolStore(state => state.addCards); //

    const { coins, spendCoins } = useCurrencyStore( //
        useShallow(state => ({
            coins: state.coins,
            spendCoins: state.spendCoins,
        }))
    );

    // ğŸ’¡ ä¿®æ­£3: åˆæœŸãƒ‘ãƒƒã‚¯é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã—ã€Pack[] ã®ä»£å…¥ã‚’é¿ã‘ã‚‹
useEffect(() => { 
    if (packs.length > 0 && selectedPack === null) {
        
        // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ä¸€è‡´ã™ã‚‹ãƒ‘ãƒƒã‚¯ã‚’æ¢ã™ (Pack | undefined)
        let packToSelect: Pack | undefined = packs.find(p => p.packId === preselectedPackId);
        
        // 2. è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€æœ€åˆã®ãƒ‘ãƒƒã‚¯ (Pack) ã‚’é¸æŠ
        // ğŸš¨ TS2740 ã‚¨ãƒ©ãƒ¼è§£æ¶ˆã®ãŸã‚ã®ä¿®æ­£: é…åˆ—å…¨ä½“ packs ã§ã¯ãªãã€æœ€åˆã®è¦ç´  packs[0] ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
        if (!packToSelect) {
            packToSelect = packs[0]; // <--- ä¿®æ­£ç®‡æ‰€
        }
        
        // 3. é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        if (packToSelect) {
            setSelectedPack(packToSelect); 
        }
    }
}, [packs, preselectedPackId, selectedPack]); 

    // ãƒ‘ãƒƒã‚¯é–‹å°ãƒ­ã‚¸ãƒƒã‚¯ (handleOpenPack) ã¯çœç•¥ï¼ˆå‰å›ã®ä¿®æ­£ã‚’ç¶­æŒï¼‰
    const handleOpenPack = async () => { 
        // ... (çœç•¥: ãƒ‘ãƒƒã‚¯é–‹å°ãƒ­ã‚¸ãƒƒã‚¯)
        if (!selectedPack) {
            setPurchaseError('ãƒ‘ãƒƒã‚¯ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return;
        }

        setPurchaseError(null);
        setLastOpenedResults(null);
        setSimulationWarning(null);

        const packPrice = selectedPack.price || 0;
        const purchaseSuccessful = await spendCoins(packPrice);

        if (!purchaseSuccessful) {
            setPurchaseError(`æ‰€æŒã‚³ã‚¤ãƒ³ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ï¼ˆå¿…è¦: ${packPrice} / æ‰€æŒ: ${coins}ï¼‰`); 
            return;
        }

        try {
            const simulationResult = simulatePackOpening(selectedPack) as unknown as SimulationResult;
            const results = simulationResult.results;
            const warning = simulationResult.simulationWarning;

            if (warning) {
                setSimulationWarning(warning);
            }

            const cardsToAdd = results.map(r => ({
                cardId: r.cardId,
                count: r.count,
                packId: selectedPack.packId 
            }));

            await addCardsToPool(cardsToAdd);

            setLastOpenedResults(results); 

        } catch (error) {
            console.error('ãƒ‘ãƒƒã‚¯é–‹å°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error); 
            setPurchaseError('ãƒ‘ãƒƒã‚¯æŠ½é¸ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); 
        }
    };


    // --- æˆ»ã‚Šå€¤ ---
    return {
        packs, 
        selectedPack,
        setSelectedPack: (packId: string) => { 
            const pack = packs.find(p => p.packId === packId);
            setSelectedPack(pack || null); 
        },
        isLoading,
        handleOpenPack,
        lastOpenedResults,
        coins,
        purchaseError,
        simulationWarning, // è­¦å‘ŠçŠ¶æ…‹ã‚’å…¬é–‹
    };
};