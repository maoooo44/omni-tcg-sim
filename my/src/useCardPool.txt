// src/features/card-pool/hooks/useCardPool.ts
import { useEffect } from 'react'; //useRefã‚’å‰Šé™¤
import { useCardPoolStore } from '../../../stores/cardPoolStore';
import { useShallow } from 'zustand/react/shallow';

/**
 * ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã®çŠ¶æ…‹ç®¡ç†ã¨æ°¸ç¶šåŒ–ï¼ˆIndexedDBï¼‰ã‚’çµ±åˆã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ Hookã€‚
 * ã“ã®Hookã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ï¼ˆä¾‹ï¼šApp.tsxï¼‰ã§ä¸€åº¦ã ã‘å‘¼ã³å‡ºã•ã‚Œã€
 * ã‚¹ãƒˆã‚¢ã®åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚
 * * ğŸ’¡ æ°¸ç¶šåŒ–ï¼ˆDBä¿å­˜ï¼‰ãƒ­ã‚¸ãƒƒã‚¯ã¯ cardPoolStore.ts ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã«é›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚
 */
export const useCardPool = () => {
    
    // Zustandã‚¹ãƒˆã‚¢ã‹ã‚‰å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨çŠ¶æ…‹ã‚’å–å¾—
    const { loadCardPool, ownedCards } = useCardPoolStore(
        useShallow(state => ({
            loadCardPool: state.loadCardPool,
            ownedCards: state.ownedCards,
        }))
    );
    
    // ----------------------------------------------------
    // 1. åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯: DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€Zustandã‚¹ãƒˆã‚¢ã‚’åˆæœŸåŒ–
    // ----------------------------------------------------
    // ğŸ’¡ ç›®çš„: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã« loadCardPool ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œ
    useEffect(() => {
        // loadCardPool ã¯ã‚¹ãƒˆã‚¢å†…ã§ DB ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè£…æ¸ˆã¿
        loadCardPool();
    }, [loadCardPool]); // loadCardPool ã¯å‚ç…§å®‰å®šæ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®š

    
    // ----------------------------------------------------
    // 2. æ°¸ç¶šåŒ–ãƒ­ã‚¸ãƒƒã‚¯ (ğŸ’¡ å‰Šé™¤ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ)
    // ----------------------------------------------------
    // ğŸ’¡ ç†ç”±: DBä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¯ cardPoolStore.ts ã® addCards/setCardCount ã«ç§»ç®¡æ¸ˆã¿ã€‚
    // Â  Â  Â  Â  Â  Hookã§ã®ç›£è¦–ã¯ä¸è¦ã¨ãªã‚Šã€ã‚¹ãƒˆã‚¢ã®å˜ä¸€è²¬ä»»åŸå‰‡ã«æº–æ‹ ã—ã¾ã™ã€‚
    // useEffect(() => {
    //     if (ownedCards.size === 0 && Array.from(ownedCards.values()).length === 0) {
    //          return;
    //     }
    //
    //     const saveToDB = async () => {
    //         await cardPoolService.bulkUpdateCardCounts(ownedCards);
    //         console.log("Card pool data saved to IndexedDB.");
    //     };
    //     
    //     const timeoutId = setTimeout(saveToDB, 500); 
    //     return () => clearTimeout(timeoutId);
    // }, [ownedCards]); 

    // ğŸ’¡ å¤–éƒ¨ã§åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ownedCards ã‚’è¿”ã™ã®ã¯ç¶­æŒ
    return { ownedCards }; 
};