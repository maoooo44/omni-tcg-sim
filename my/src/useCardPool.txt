// src/features/card-pool/hooks/useCardPool.ts
import { useEffect } from 'react'; //useRefを削除
import { useCardPoolStore } from '../../../stores/cardPoolStore';
import { useShallow } from 'zustand/react/shallow';

/**
 * カードプールの状態管理と永続化（IndexedDB）を統合するカスタムHook。
 * このHookは、アプリケーションのルートレベル（例：App.tsx）で一度だけ呼び出され、
 * ストアの初期ロードをトリガーします。
 * * 💡 永続化（DB保存）ロジックは cardPoolStore.ts のアクション内に集約されています。
 */
export const useCardPool = () => {
    
    // Zustandストアから必要なアクションと状態を取得
    const { loadCardPool, ownedCards } = useCardPoolStore(
        useShallow(state => ({
            loadCardPool: state.loadCardPool,
            ownedCards: state.ownedCards,
        }))
    );
    
    // ----------------------------------------------------
    // 1. 初期化ロジック: DBからデータをロードし、Zustandストアを初期化
    // ----------------------------------------------------
    // 💡 目的: アプリケーション起動時に loadCardPool アクションを一度だけ実行
    useEffect(() => {
        // loadCardPool はストア内で DB ロードを実装済み
        loadCardPool();
    }, [loadCardPool]); // loadCardPool は参照安定性が保証されていると仮定

    
    // ----------------------------------------------------
    // 2. 永続化ロジック (💡 削除・コメントアウト)
    // ----------------------------------------------------
    // 💡 理由: DB保存ロジックは cardPoolStore.ts の addCards/setCardCount に移管済み。
    //           Hookでの監視は不要となり、ストアの単一責任原則に準拠します。
    // useEffect(() => {
    //     if (ownedCards.size === 0 && Array.from(ownedCards.values()).length === 0) {
    //          return;
    //     }
    //
    //     const saveToDB = async () => {
    //         await cardPoolService.bulkUpdateCardCounts(ownedCards);
    //         console.log("Card pool data saved to IndexedDB.");
    //     };
    //     
    //     const timeoutId = setTimeout(saveToDB, 500); 
    //     return () => clearTimeout(timeoutId);
    // }, [ownedCards]); 

    // 💡 外部で利用される可能性があるため、ownedCards を返すのは維持
    return { ownedCards }; 
};