// src/services/currency/currencyService.ts (æ–°è¦ä½œæˆ)

import { db } from '../database/db';
import type { DBSetting } from '../../models/db-types'; // ğŸ’¡ ä¿®æ­£: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚’db-typesã«ä¿®æ­£

const COINS_KEY = 'coins';

/**
 * IndexedDB (Dexie) ã® 'userSettings' ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®é€šè²¨ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹æ“ä½œã‚’æ‰±ã†ã‚µãƒ¼ãƒ“ã‚¹
 */
export const currencyService = {

    /**
     * DBã‹ã‚‰ã‚³ã‚¤ãƒ³æ•°ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
     * @returns ã‚³ã‚¤ãƒ³æ•° (number)ã€‚DBã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ undefined ã‚’è¿”ã™ã€‚
     */
    async loadCoins(): Promise<number | undefined> {
        try {
            // key: 'coins' ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢
            const entry = await db.userSettings.get(COINS_KEY);
            
            if (entry) {
                // å€¤ã‚’ number å‹ã«ã‚­ãƒ£ã‚¹ãƒˆã—ã¦è¿”ã™
                return entry.value as number;
            }
            // ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ undefined
            return undefined; 
        } catch (error) {
            console.error("Failed to load coins from DB:", error);
            return undefined; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ undefined ã‚’è¿”ã™
        }
    },

    /**
     * ç¾åœ¨ã®ã‚³ã‚¤ãƒ³æ•°ã‚’DBã«ä¿å­˜ã™ã‚‹ï¼ˆæ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆï¼‰ã€‚
     * @param coins - ä¿å­˜ã™ã‚‹ã‚³ã‚¤ãƒ³æ•°
     */
    async saveCoins(coins: number): Promise<void> {
        try {
            const setting: DBSetting = {
                key: COINS_KEY,
                value: coins
            };
            // put ã§æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
            await db.userSettings.put(setting);
        } catch (error) {
            console.error("Failed to save coins to DB:", error);
        }
    },
};