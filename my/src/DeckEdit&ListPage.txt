// src/pages/DeckEditPage.tsx

import React from 'react';
import { useParams} from '@tanstack/react-router'; //useNavigateã‚’å‰Šé™¤
import { useShallow } from 'zustand/react/shallow';
import { Box, Alert } from '@mui/material';

// ğŸ’¡ Featureã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨Hookã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import DeckEditor from '../features/deck-management/DeckEditor'; 
import { useDeckEditor } from '../features/deck-management/hooks/useDeckEditor'; 

import { useDeckStore } from '../stores/deckStore';


const DeckEditPage: React.FC = () => {
    // ğŸ’¡ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰deckIdã‚’å–å¾—
    const { deckId } = useParams({ strict: false }) as { deckId: string | undefined };
    
    // ğŸ’¡ useDeckEditor hookã‹ã‚‰å…¨ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const {
        isLoading,
        currentDeck,
        saveMessage,
        updateDeckInfo,
        handleSaveDeck,
        handleDeleteDeck,
    } = useDeckEditor(deckId || 'create'); // IDãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦æ‰±ã†

    // ğŸ’¡ storeã‹ã‚‰ç›´æ¥ã€ã‚«ãƒ¼ãƒ‰ã®è¿½åŠ /å‰Šé™¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾— (DeckEditorã«ç›´æ¥æ¸¡ã™ãŸã‚)
    const { addCardToDeck, removeCardFromDeck } = useDeckStore(
        useShallow(state => ({
            addCardToDeck: state.addCardToDeck,
            removeCardFromDeck: state.removeCardFromDeck,
        }))
    );

    // ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º
    if (isLoading) {
        return (
            <Box sx={{ p: 3 }}>
                <Alert severity="info">
                    ãƒ‡ãƒƒã‚­ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...
                </Alert>
            </Box>
        );
    }
    
    // ğŸ’¡ ãƒ­ãƒ¼ãƒ‰å¾Œã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    if (!currentDeck || (!deckId && currentDeck.deckId === '')) {
         return (
            <Box sx={{ p: 3 }}>
                <Alert severity="error">
                    ç·¨é›†ã™ã‚‹ãƒ‡ãƒƒã‚­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
                </Alert>
            </Box>
         );
    }

    // ğŸ’¡ Featureã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    return (
        <Box sx={{ flexGrow: 1 }}>
            <DeckEditor
                deck={currentDeck}
                addCard={addCardToDeck} 
                removeCard={removeCardFromDeck} 
                onSave={handleSaveDeck} 
                onDelete={handleDeleteDeck} 
                updateDeckInfo={updateDeckInfo} 
                saveMessage={saveMessage}
            />
        </Box>
    );
};

export default DeckEditPage;



// src/pages/DeckListPage.tsx ã®ã¯ãšãŒä¸­èº«ãŒ
// src/pages/PackListPage.tsx (FULL REVISION)ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹

import React from 'react';
// æ¨™æº–ã®Gridã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (v7ã§ã¯ã“ã‚ŒãŒæ–°ã—ã„Grid)
import { Grid, Card, CardContent, Typography, CardActionArea, Box, CardMedia } from '@mui/material';
import AddIcon from '@mui/icons-material/Add';
import { usePackStore } from '../stores/packStore';
import { useNavigate } from '@tanstack/react-router';
import { useShallow } from 'zustand/react/shallow';
// import { generateUUID } from '../utils/uuidUtils'; // UUIDç”Ÿæˆã‚’ä½¿ç”¨

const PackListPage: React.FC = () => {
  const packs = usePackStore(useShallow(state => state.packs));
  const navigate = useNavigate();

  // ğŸ’¡ ãƒ‘ã‚¹ã‚’ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›´: /packs/$packId
  // æ—¢å­˜ãƒ‘ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
  const handleSelectPack = (packId: string) => {
    navigate({ to: `/data/packs/$packId`, params: { packId } });
  };
  
  // ğŸ’¡ ãƒ‘ã‚¹ã‚’ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›´: /packs/create
  // æ–°è¦ä½œæˆã‚«ãƒ¼ãƒ‰ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
  const handleNewPack = () => {
    // ğŸ’¡ æ–°è¦ä½œæˆã¯ID 'create' ã‚’ä½¿ç”¨ã—ã€Editorå´ã§æ–°è¦Deck/Packã‚’ç”Ÿæˆã™ã‚‹ã®ãŒä¸€èˆ¬çš„
    navigate({ to: `/data/packs/$packId`, params: { packId: 'create' } });
  };

  const PACK_CARD_WIDTH = 200; 
  const PACK_CARD_HEIGHT = 280; 

  return (
    <Box sx={{ flexGrow: 1, p: 1 }}>
        <Typography variant="h4" gutterBottom>
            ãƒ‘ãƒƒã‚¯ä¸€è¦§
        </Typography>
        
        {/* Gridã‚’containerã¨ã—ã¦ä½¿ç”¨ */}
        <Grid container spacing={2}>
            
            {/* 1. æ–°è¦ä½œæˆã®ã‚«ãƒ¼ãƒ‰ï¼ˆå·¦ä¸Šï¼‰ */}
            <Grid> {/* ğŸ’¡ Grid item ã‚’è¿½åŠ  */}
            <Card 
                sx={{ 
                    width: PACK_CARD_WIDTH, 
                    height: PACK_CARD_HEIGHT,
                    border: '2px dashed', // ğŸ’¡ dashedã«å¤‰æ›´
                    borderColor: 'grey.400', 
                    backgroundColor: 'grey.50',
                    boxShadow: 0,
                    transition: 'box-shadow 0.3s',
                    '&:hover': {
                        boxShadow: 3, 
                    }
                }}
                onClick={handleNewPack}
            >
                <CardActionArea sx={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center' }}>
                    <AddIcon sx={{ fontSize: 60, color: 'grey.500' }} />
                    <Typography variant="subtitle1" color="grey.600" sx={{ mt: 1 }}>
                        æ–°è¦ä½œæˆ
                    </Typography>
                </CardActionArea>
            </Card>
            </Grid>
            
            {/* 2. æ—¢å­˜ã®ãƒ‘ãƒƒã‚¯ä¸€è¦§ */}
            {packs.map(pack => ( 
                <Grid key={pack.packId}> {/* ğŸ’¡ Grid item ã‚’è¿½åŠ  */}
                    <Card 
                        sx={{ 
                            width: PACK_CARD_WIDTH, 
                            height: PACK_CARD_HEIGHT,
                            cursor: 'pointer',
                            boxShadow: 1, 
                        }}
                        onClick={() => handleSelectPack(pack.packId)}
                    >
                        <CardActionArea sx={{ height: '100%', display: 'flex', flexDirection: 'column', justifyContent: 'space-between' }}>
                            <CardMedia
                                component="img"
                                image={pack.imageUrl || 'https://via.placeholder.com/200x150?text=Pack+Image'}
                                alt={pack.name}
                                sx={{ height: 150, objectFit: 'cover' }}
                            />
                            <CardContent sx={{ p: 1, '&:last-child': { pb: 1 } }}>
                                <Typography variant="subtitle1" noWrap>{pack.name}</Typography>
                                <Typography variant="caption" color="text.secondary">
                                    {pack.series} | {pack.cardsPerPack}æš
                                </Typography>
                            </CardContent>
                        </CardActionArea>
                    </Card>
                </Grid>
            ))}
        </Grid>
    </Box>
  );
};

export default PackListPage;