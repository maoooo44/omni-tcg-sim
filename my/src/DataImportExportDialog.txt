// src/components/DataImportExportDialog.tsx
import React, { useState, useRef } from 'react';
import { 
    Dialog, DialogTitle, DialogContent, DialogActions, 
    Button, Typography, Box, Alert, CircularProgress, 
    Divider 
} from '@mui/material';
import FileUploadIcon from '@mui/icons-material/FileUpload';
import FileDownloadIcon from '@mui/icons-material/FileDownload';
import { zipImportExportService } from '../services/data-import-export/zipImportExportService';
import { useCardPoolStore } from '../stores/cardPoolStore'; // ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¾Œã®ãƒªãƒ­ãƒ¼ãƒ‰ã«å¿…è¦

interface DataImportExportDialogProps {
    open: boolean;
    onClose: () => void;
}

const DataImportExportDialog: React.FC<DataImportExportDialogProps> = ({ open, onClose }) => {
    const [status, setStatus] = useState<'idle' | 'loading'>('idle');
    const [message, setMessage] = useState<{ type: 'success' | 'error' | 'info', text: string } | null>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const loadCardPool = useCardPoolStore(state => state.loadCardPool); // æˆåŠŸå¾Œã®å†ãƒ­ãƒ¼ãƒ‰

    // --------------------------------------------------
    // ğŸ’¡ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†
    // --------------------------------------------------
    const handleExport = async () => {
        setStatus('loading');
        setMessage(null);
        try {
            const blob = await zipImportExportService.exportData();
            
            // Blobã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tcg-builder-data-${new Date().toISOString().substring(0, 10)}.zip`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url); // ãƒ¡ãƒ¢ãƒªè§£æ”¾
            
            setMessage({ type: 'success', text: 'å…¨ãƒ‡ãƒ¼ã‚¿ã®ZIPã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚' });
        } catch (error) {
            console.error('Export failed:', error);
            setMessage({ type: 'error', text: `ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}` });
        } finally {
            setStatus('idle');
        }
    };

    // --------------------------------------------------
    // ğŸ’¡ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç† (ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨ãƒ‡ãƒ¼ã‚¿çµ±åˆ)
    // --------------------------------------------------
    const handleImport = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file || !file.name.endsWith('.zip')) {
            setMessage({ type: 'error', text: 'æœ‰åŠ¹ãª.zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚' });
            return;
        }

        setStatus('loading');
        setMessage(null);

        try {
            // ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã€ãƒ‡ãƒ¼ã‚¿çµ±åˆã‚’å®Ÿè¡Œ
            const resultSummary = await zipImportExportService.importData(file);
            
            // ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«å¼·åˆ¶æ›´æ–° (Zustandã‚¹ãƒˆã‚¢çµŒç”±ã§)
            await loadCardPool(); 

            setMessage({ 
                type: 'success', 
                text: `ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨çµ±åˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n${resultSummary}` 
            });

        } catch (error) {
            console.error('Import failed:', error);
            setMessage({ type: 'error', text: `ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}` });
        } finally {
            setStatus('idle');
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
            if (fileInputRef.current) {
                fileInputRef.current.value = ''; 
            }
        }
    };

    // --------------------------------------------------
    // ğŸ’¡ UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // --------------------------------------------------
    return (
        <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
            <DialogTitle>ãƒ‡ãƒ¼ã‚¿ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</DialogTitle>
            <DialogContent dividers>
                {/* 1. èª¬æ˜ */}
                <Typography variant="body2" color="text.secondary" gutterBottom>
                    ã“ã®æ©Ÿèƒ½ã¯ã€ãƒ‘ãƒƒã‚¯ã€ãƒ‡ãƒƒã‚­ã€ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãªã©ã€ã‚¢ãƒ—ãƒªã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å˜ä¸€ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å…¥å‡ºåŠ›ã—ã¾ã™ã€‚
                </Typography>
                
                {/* 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
                {message && (
                    <Alert 
                        severity={message.type} 
                        sx={{ mt: 2, whiteSpace: 'pre-wrap' }}
                        onClose={() => setMessage(null)}
                    >
                        {message.text}
                    </Alert>
                )}
                
                {/* 3. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                <Box sx={{ mt: 3, mb: 2 }}>
                    <Typography variant="h6" gutterBottom>
                        <FileDownloadIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                        ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </Typography>
                    <Button 
                        variant="contained" 
                        color="primary" 
                        onClick={handleExport} 
                        disabled={status === 'loading'}
                        startIcon={status === 'loading' ? <CircularProgress size={20} color="inherit" /> : <FileDownloadIcon />}
                        sx={{ mt: 1 }}
                    >
                        å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ZIPãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </Button>
                </Box>

                <Divider sx={{ my: 2 }} />

                {/* 4. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                <Box>
                    <Typography variant="h6" gutterBottom>
                        <FileUploadIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                        ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (ä¸Šæ›¸ãæ³¨æ„)
                    </Typography>
                    <Typography variant="body2" color="error" sx={{ mb: 1 }}>
                        ã€é‡è¦ã€‘ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¯ã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’**å®Œå…¨ã«ä¸Šæ›¸ã**ã—ã¾ã™ã€‚
                    </Typography>

                    <input
                        type="file"
                        accept=".zip"
                        ref={fileInputRef}
                        onChange={handleImport}
                        style={{ display: 'none' }}
                        id="zip-import-file"
                        disabled={status === 'loading'}
                    />
                    <Button
                        variant="outlined"
                        component="label"
                        htmlFor="zip-import-file"
                        disabled={status === 'loading'}
                        startIcon={status === 'loading' ? <CircularProgress size={20} color="inherit" /> : <FileUploadIcon />}
                        sx={{ mt: 1 }}
                    >
                        ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </Button>
                </Box>

            </DialogContent>
            <DialogActions>
                <Button onClick={onClose} color="primary" disabled={status === 'loading'}>
                    é–‰ã˜ã‚‹
                </Button>
            </DialogActions>
        </Dialog>
    );
};

export default DataImportExportDialog;